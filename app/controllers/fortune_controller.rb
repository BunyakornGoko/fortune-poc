class FortuneController < ApplicationController
  def index
    @remaining_count = FortuneNumber.remaining_count
  end

  def draw
    # เลือกหัวข้อคำทำนายจากพารามิเตอร์
    category = params[:category].to_s.presence || "study"

    fortunes_by_category_thai = {
      "study" => [
        "ดาวประจำวันส่องสว่างด้านการศึกษา การเรียนของคุณกำลังไปได้สวย เพียงตั้งใจอีกนิดจะสำเร็จแน่นอน วันนี้เหมาะกับการอ่านหนังสือช่วงเช้าหรือก่อนนอน",
        "เกรดของคุณกำลังพุ่งสูงขึ้น มีโอกาสได้เจอครูดีเพื่อนดีที่สนับสนุนให้ก้าวหน้า ลองเข้าร่วมกิจกรรมชมรมหรือกลุ่มอ่านหนังสือ จะได้แรงบันดาลใจใหม่",
        "ความรู้ที่คุณสะสมมากำลังเชื่อมโยงกัน อ่านทบทวนอีกครั้งจะเข้าใจลึกซึ้งและทำคะแนนได้ดี ถ้ามีข้อสงสัยอย่าลังเลที่จะถาม คำตอบจะนำไปสู่ความเข้าใจที่ลึกกว่าเดิม",
        "จันทร์เสริมพลังสมาธิให้คุณเป็นพิเศษ วันนี้เหมาะกับการเริ่มต้นหัวข้อใหม่ ผลลัพธ์จะเกินคาด จดโน้ตด้วยปากกาสีน้ำเงินจะช่วยให้จำได้ดีขึ้น",
        "เส้นทางสู่ความสำเร็จของคุณกำลังเปิดกว้าง ความพยายามไม่เคยทรยศคุณ สอบครั้งนี้มีข่าวดีแน่ อย่าลืมทบทวนเนื้อหาที่เคยผ่านตา มันสำคัญกว่าที่คิด",
        "สมองของคุณต้องการระบบใหม่ จัดตารางอ่านหนังสือใหม่จะช่วยให้มีสมาธิและต่อเนื่อง แบ่งเวลาอ่านเป็นช่วงๆ พักสมองทุก 25 นาที จะทำให้จำได้ดีขึ้น",
        "ดวงการเรียนของคุณมั่นคงมาก อย่ากังวลเกินไป คุณมีพื้นฐานที่แข็งแรงอยู่แล้ว เพียงแค่เชื่อมันตัวเองและทำอย่างสม่ำเสมอ ผลลัพธ์จะตามมาเอง",
        "การเรียนรู้แบบเดิมอาจไม่ได้ผลแล้ว ลองเปลี่ยนวิธีจำจะทำให้เข้าใจและจำได้ยาวนาน ใช้แผนผัง เขียนภาพ หรือสอนเพื่อน วิธีใหม่จะเปิดโลกความเข้าใจ",
        "อย่าเก็บคำถามไว้ในใจ ถามให้ชัดเมื่อไม่เข้าใจจะช่วยให้คุณก้าวกระโดด ครูและเพื่อนพร้อมช่วยเหลือคุณมากกว่าที่คิด เลขมงคลวันนี้คือ 7",
        "พลังงานต้องการสมดุล แบ่งเวลาให้สมดุลระหว่างเรียนและพักจะทำให้มีพลัง อย่าเรียนติดต่อกันนานเกิน 2 ชั่วโมง เดินเล่นหายใจอากาศบ้าง สมองจะทำงานได้ดีขึ้น"
      ],
      "love" => [
        "ดวงความรักอุ่นมากในช่วงนี้ ความรักกำลังก่อตัวอย่างอบอุ่น คุยกันด้วยใจจะเข้าใจกันมากขึ้น อย่ารีบร้อนเร่งรัด ให้เวลาความรู้สึกพัฒนาไปตามธรรมชาติ",
        "โสดมีเกณฑ์พลิกชีวิต คนโสดมีเกณฑ์ได้พบคนถูกใจจากการแนะนำของเพื่อน หรือเจอในงานสังสรรค์ช่วงบ่าย การเปิดใจรับคนใหม่จะทำให้เห็นโอกาสดี สีมงคลคือสีชมพูอ่อน",
        "ความไว้วางใจกำลังเติบโต ความสัมพันธ์จะมั่นคงขึ้นหากสื่อสารอย่างจริงใจ พูดคุยเรื่องความรู้สึกกันตรงๆ อย่าเก็บงำไว้ในใจ ความเข้าใจจะเกิดขึ้นเมื่อทั้งคู่เปิดใจ",
        "ช่วงนี้อาจมีเรื่องเล็กน้อยขัดแย้ง อดทนและรับฟังกันมากขึ้นปัญหาจะคลี่คลายลง อย่าตัดสินใจอะไรตอนโกรธ พูดคุยกันเมื่อใจเย็นจะได้คำตอบที่ดีกว่า",
        "คนรักต้องการแค่ความใส่ใจ คนรักต้องการกำลังใจ คำพูดดีๆ จะสร้างพลังให้กัน ส่งข้อความหวานๆ หรือชมเขาบ้าง ความสัมพันธ์จะหวานขึ้นทันที เวลามงคลคือช่วงเย็น",
        "ความรักต้องการความเป็นธรรมชาติ อย่าคาดหวังสูงเกินไป ให้เวลานำพาไปอย่างเป็นธรรมชาติ ทุกความสัมพันธ์มีจังหวะของมันเอง รีบไปก็ไปไม่ถึง ค่อยๆ เดินไปด้วยกันดีกว่า",
        "ความทรงจำดีๆ กำลังสร้างขึ้น เรื่องเล็กๆ ที่ทำให้กันจะกลายเป็นความทรงจำที่ดี ชวนไปกินข้าวร้านประจำ ดูหนังที่ชอบด้วยกัน สิ่งเรียบง่ายคือสิ่งที่ยั่งยืน",
        "อย่าตัดสินใจใหญ่โตเร็วเกินไป ยังไม่ใช่เวลาตัดสินใจครั้งใหญ่ ค่อยๆ เรียนรู้กันไปก่อน รีบร้อนไปก็อาจจะเสียดาย ให้เวลาทั้งคู่ได้เข้าใจกันลึกซึ้งขึ้น",
        "คุณค่าของอีกฝ่ายกำลังปรากฏ เปิดใจเล็กน้อย คุณจะเห็นคุณค่าของอีกฝ่ายมากขึ้น บางทีสิ่งที่เราไม่ชอบ กลับเป็นจุดเด่นของเขา ลองมองในมุมใหม่บ้างจะเห็นความน่ารัก",
        "รากฐานความรักเริ่มจากตัวเอง ความรักดีๆ เริ่มจากการรักตัวเองอย่างพอดี ดูแลตัวเองให้ดี มีเวลาให้ตัวเอง เมื่อคุณรักตัวเอง คุณก็จะให้ความรักที่ดีได้"
      ],
      "health" => [
        "ร่างกายต้องการการพักฟื้น พักผ่อนให้เพียงพอ ร่างกายจะสดชื่นและฟื้นตัวเร็ว นอนก่อน 4 ทุ่มจะดีที่สุด หลีกเลี่ยงหน้าจอโทรศัพท์ก่อนนอน 30 นาทีจะหลับสบาย",
        "เซลล์ร่างกายต้องการน้ำ ดื่มน้ำมากขึ้น วันนี้ร่างกายต้องการการดูแลเป็นพิเศษ ดื่มน้ำอุ่นตอนเช้าจะช่วยล้างสารพิษ ตั้งเป้า 8 แก้วต่อวันจะรู้สึกสดชื่นขึ้นเยอะ",
        "พลังงานในตัวต้องการการหมุนเวียน ออกกำลังกายเบาๆ จะช่วยให้สมองปลอดโปร่ง เดิน 15 นาที ยืดเหยียด หรือโยคะง่ายๆ ก็ได้ผล ไม่ต้องหนักหนาแค่ขยับร่างกายก็ดีแล้ว",
        "ร่างกายกำลังส่งสัญญาณ อย่าฝืนเกินไป ฟังสัญญาณจากร่างกายของคุณ ถ้าเหนื่อยให้พัก ถ้าปวดอย่าทนไว้นาน การดูแลตัวเองทันท่วงทีจะป้องกันปัญหาใหญ่",
        "พฤติกรรมเล็กน้อยสร้างความแตกต่าง เปลี่ยนพฤติกรรมเล็กน้อย สุขภาพจะดีขึ้นอย่างเห็นได้ชัด ขึ้นบันไดแทนลิฟต์ เดินแทนนั่งรถ ปรับอนาคตด้วยการเปลี่ยนแปลงวันนี้",
        "สุขภาพดีเริ่มจากจานอาหาร โภชนาการที่สมดุลจะช่วยให้พลังงานคุณคงที่ทั้งวัน กินผักผลไม้หลากสี ลดของทอดและหวานจัด ร่างกายจะขอบคุณคุณ",
        "การป้องกันดีกว่าการรักษา ตรวจสุขภาพประจำปีจะช่วยป้องกันปัญหาได้ทันท่วงที อย่ารอจนมีอาการค่อยไปหาหมอ เช็กสุขภาพเป็นประจำคือการลงทุนที่คุ้มค่า",
        "ความเครียดกำลังสะสม ลดความเครียดด้วยการหายใจลึกๆ ใจจะสงบและนิ่ง หายใจเข้า 4 วินาที กลั้น 4 วินาที หายใจออก 4 วินาที ทำซ้ำ 5 รอบจะรู้สึกผ่อนคลาย",
        "วิตามินดีต้องการเติมเต็ม เดินเล่นรับแดดอ่อนๆ จะช่วยให้หลับสบายคืนนี้ ออกไปตอนเช้า 7-9 โมง 15 นาทีก็พอ ร่างกายจะได้วิตามินดีและอากาศบริสุทธิ์",
        "กล้ามเนื้อต้องการการยืด อย่าลืมยืดกล้ามเนื้อ บรรเทาความตึงเครียดจากการนั่งนาน ยืดคอ ไหล่ หลัง และขา ทุก 1 ชั่วโมง จะช่วยลดอาการปวดเมื่อย"
      ],
      "finance" => [
        "กระแสเงินกำลังไหลเข้า รายได้กำลังค่อยๆ ดีขึ้น จัดการการเงินอย่างมีวินัยจะมั่นคง จดบันทึกรายรับรายจ่ายทุกวัน เห็นภาพชัดจะวางแผนได้ดีขึ้น",
        "การวางแผนคือกุญแจสำคัญ วางแผนค่าใช้จ่ายวันนี้จะช่วยลดความกังวลในอนาคต แบ่งเงินเป็นสัดส่วน 50% ใช้จ่าย 30% อิสระ 20% เก็บออม จะทำให้ชีวิตการเงินสมดุล",
        "โอกาสทองกำลังเคาะประตู โอกาสเล็กๆ ทางการเงินกำลังจะมา คว้าไว้ให้ดี อาจเป็นงานพิเศษ โปรโมชันพิเศษ หรือส่วนลด เปิดหูเปิดตาจะไม่พลาดโอกาสดี",
        "ความรีบร้อนทำให้พลาดพลั้ง อย่ารีบร้อนลงทุน ศึกษาให้รอบด้านก่อนตัดสินใจ อ่านรีวิว ถามคนมีประสบการณ์ วิเคราะห์ข้อดีข้อเสีย การรอคอยสักนิดจะช่วยป้องกันความเสียใจ",
        "เม็ดเงินเล็กๆ สร้างภูเขา หมั่นออมเล็กๆ แต่สม่ำเสมอจะกลายเป็นก้อนใหญ่ เริ่มจากวันละ 20 บาท เดือนละ 600 บาท ปีละ 7,200 บาท สิบปีคือ 72,000 บาท",
        "ของที่ใช่กำลังรอคุณอยู่ มีเกณฑ์ได้ของที่อยากได้ในราคาคุ้มค่า ติดตามช่องทางลดราคา ดีลพิเศษอาจโผล่มาไม่ทันตั้งตัว แต่อย่าลืมว่าต้องเป็นของที่ต้องการจริงๆ",
        "ความพยายามกำลังเปลี่ยนเป็นรางวัล ความพยายามในงานจะเปลี่ยนเป็นผลตอบแทนที่ดี เงินเดือนอาจขึ้น โบนัสอาจมา หรืองานพิเศษเข้า ทำหน้าที่ให้ดีต่อไป ผลลัพธ์ดีๆ กำลังจะตามมา",
        "รายจ่ายฟุ่มเฟือยทำลายเป้าหมาย ตัดค่าใช้จ่ายฟุ่มเฟือยหนึ่งอย่าง กระเป๋าจะเบาขึ้นทันที ทบทวนรายการที่จ่ายประจำเดือน มีอะไรที่ตัดออกได้บ้างไหม ลด 1,000 บาทต่อเดือน ปีเดียวก็เก็บได้ 12,000",
        "คำแนะนำดีๆ อยู่ใกล้ตัว คนใกล้ตัวให้คำแนะนำการเงินที่มีประโยชน์ ลองฟังดู อาจจะเป็นพ่อแม่ เพื่อนที่รอบคอบ หรือพี่ที่ประสบความสำเร็จ ประสบการณ์คนอื่นช่วยให้เราหลีกเลี่ยงหลุมพราง",
        "เป้าหมายต้องการการทบทวน วันนี้เหมาะกับการทบทวนเป้าหมายทางการเงินอีกครั้ง เป้ายังเหมาะสมไหม ต้องปรับอะไรบ้าง เขียนเป้าหมายใหม่ พร้อมแผนการบรรลุ จะช่วยให้มีทิศทางชัดเจน"
      ]
    }

    fortunes_by_category_chinese = {
      "study" => [
        "学业顺遂，再接再厉",
        "良师益友，相伴前行",
        "温故知新，成绩可期",
        "开卷有益，进步飞快",
        "勤能补拙，必有佳讯",
        "循序渐进，心明眼亮",
        "不必多忧，基础扎实",
        "触类旁通，记忆长久",
        "疑则问之，进益神速",
        "张弛有度，精力充沛"
      ],
      "love" => [
        "情意渐浓，以诚相待",
        "桃花临门，缘来有时",
        "沟通真挚，感情稳固",
        "多些包容，风波自平",
        "一句暖语，胜过千言",
        "不急不躁，顺其自然",
        "点滴关怀，温暖长存",
        "且行且看，勿急定论",
        "放宽心胸，自见美好",
        "爱人先爱己，福自来"
      ],
      "health" => [
        "早睡早起，气色更佳",
        "多饮清水，润泽身心",
        "舒展筋骨，轻松自在",
        "量力而行，切莫逞强",
        "细微改良，立见其效",
        "饮食均衡，精力充沛",
        "定期体检，防患未然",
        "深呼吸静心，忧虑自减",
        "沐浴晨光，夜眠香甜",
        "缓解紧绷，身心轻盈"
      ],
      "finance" => [
        "财源渐进，守正以稳",
        "精打细算，未雨绸缪",
        "小有机遇，握之不失",
        "投资需谨慎，多方求证",
        "积少成多，日久见功",
        "物有所值，买得其所",
        "勤勉有成，酬劳自至",
        "节流一项，轻松不少",
        "善纳良言，收益颇多",
        "回顾目标，步步为营"
      ]
    }

    thai_fortunes = fortunes_by_category_thai[category] || fortunes_by_category_thai["study"]
    chinese_fortunes = fortunes_by_category_chinese[category] || fortunes_by_category_chinese["study"]

    thai_fortune = thai_fortunes.sample
    chinese_fortune = chinese_fortunes.sample
    
    # สุ่มสีโชคดี
    lucky_colors = ["แดง", "ทอง", "เหลือง", "ม่วง", "ชมพู"]
    lucky_color = lucky_colors.sample
    
    # สุ่มตัวเลขโชคดี
    lucky_numbers = Array.new(6) { rand(1..49) }.uniq.sort
    
    # สุ่มหมายเลขของรางวัลจากฐานข้อมูลและลบทันที
    prize_number = FortuneNumber.draw_and_remove!
    remaining_count = FortuneNumber.remaining_count
    
    if prize_number
      render json: {
        thai_fortune: thai_fortune,
        chinese_fortune: chinese_fortune,
        lucky_color: lucky_color,
        lucky_numbers: lucky_numbers,
        prize_number: prize_number,
        remaining_prizes: remaining_count,
        success: true
      }
    else
      render json: {
        success: false,
        message: "ของรางวัลหมดแล้ว! กรุณารีเซ็ตระบบ",
        remaining_prizes: 0
      }
    end
  end

  # ฟังก์ชันรีเซ็ตหมายเลขทั้งหมด (สำหรับ admin)
  def reset_numbers
    FortuneNumber.reset_all!
    render json: {
      success: true,
      message: "รีเซ็ตหมายเลขเสร็จแล้ว! มีหมายเลข 100 ตัวให้สุ่มใหม่",
      remaining_prizes: FortuneNumber.remaining_count
    }
  end

  # ฟังก์ชันลบตัวเลขเฉพาะ
  def delete_number
    number = params[:number].to_i
    
    if number < 1 || number > 100
      render json: {
        success: false,
        message: "กรุณาใส่หมายเลขระหว่าง 1-100"
      }
      return
    end
    
    fortune_number = FortuneNumber.find_by(number: number)
    
    if fortune_number
      fortune_number.destroy!
      render json: {
        success: true,
        message: "ลบหมายเลข #{number} เรียบร้อยแล้ว",
        remaining_prizes: FortuneNumber.remaining_count
      }
    else
      render json: {
        success: false,
        message: "ไม่พบหมายเลข #{number} ในระบบ (อาจถูกลบไปแล้ว)"
      }
    end
  end

  # ฟังก์ชันเช็คสถานะหมายเลขที่เหลือ
  def status
    render json: {
      remaining_prizes: FortuneNumber.remaining_count,
      has_prizes: FortuneNumber.any_remaining?
    }
  end
end
