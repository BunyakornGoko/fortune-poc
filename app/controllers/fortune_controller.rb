class FortuneController < ApplicationController
  def index
    @remaining_count = FortuneNumber.remaining_count
  end

  def draw
    # เลือกหัวข้อคำทำนายจากพารามิเตอร์
    category = params[:category].to_s.presence || "study"

    fortunes_by_category_thai = {
      "study" => [
        "การเรียนของคุณกำลังไปได้สวย เพียงตั้งใจอีกนิดจะสำเร็จแน่นอน",
        "มีโอกาสได้เจอครูดี เพื่อนดี สนับสนุนให้คุณก้าวหน้า",
        "อ่านทบทวนอีกครั้งหนึ่ง จะเข้าใจลึกซึ้งและทำคะแนนได้ดี",
        "วันนี้เหมาะกับการเริ่มต้นหัวข้อใหม่ ผลลัพธ์จะเกินคาด",
        "ความพยายามไม่เคยทรยศคุณ สอบครั้งนี้มีข่าวดีแน่",
        "จัดตารางอ่านหนังสือใหม่ จะช่วยให้มีสมาธิและต่อเนื่อง",
        "อย่ากังวลเกินไป คุณมีพื้นฐานที่แข็งแรงอยู่แล้ว",
        "ลองเปลี่ยนวิธีจำ จะทำให้เข้าใจและจำได้ยาวนาน",
        "ถามให้ชัดเมื่อไม่เข้าใจ จะช่วยให้คุณก้าวกระโดด",
        "แบ่งเวลาให้สมดุล ระหว่างเรียนและพัก จะทำให้มีพลัง"
      ],
      "love" => [
        "ความรักกำลังก่อตัวอย่างอบอุ่น คุยกันด้วยใจจะเข้าใจกันมากขึ้น",
        "คนโสดมีเกณฑ์ได้พบคนถูกใจจากการแนะนำของเพื่อน",
        "ความสัมพันธ์จะมั่นคงขึ้น หากสื่อสารอย่างจริงใจ",
        "อดทนและรับฟังกันมากขึ้น ปัญหาจะคลี่คลายลง",
        "คนรักต้องการกำลังใจ คำพูดดีๆ จะสร้างพลังให้กัน",
        "อย่าคาดหวังสูงเกินไป ให้เวลานำพาไปอย่างเป็นธรรมชาติ",
        "เรื่องเล็กๆ ที่ทำให้กัน จะกลายเป็นความทรงจำที่ดี",
        "ยังไม่ใช่เวลาตัดสินใจครั้งใหญ่ ค่อยๆ เรียนรู้กันไปก่อน",
        "เปิดใจเล็กน้อย คุณจะเห็นคุณค่าของอีกฝ่ายมากขึ้น",
        "ความรักดีๆ เริ่มจากการรักตัวเองอย่างพอดี"
      ],
      "health" => [
        "พักผ่อนให้เพียงพอ ร่างกายจะสดชื่นและฟื้นตัวเร็ว",
        "ดื่มน้ำมากขึ้น วันนี้ร่างกายต้องการการดูแลเป็นพิเศษ",
        "ออกกำลังกายเบาๆ จะช่วยให้สมองปลอดโปร่ง",
        "อย่าฝืนเกินไป ฟังสัญญาณจากร่างกายของคุณ",
        "เปลี่ยนพฤติกรรมเล็กน้อย สุขภาพจะดีขึ้นอย่างเห็นได้ชัด",
        "โภชนาการที่สมดุล จะช่วยให้พลังงานคุณคงที่ทั้งวัน",
        "ตรวจสุขภาพประจำปี จะช่วยป้องกันปัญหาได้ทันท่วงที",
        "ลดความเครียดด้วยการหายใจลึกๆ ใจจะสงบและนิ่ง",
        "เดินเล่นรับแดดอ่อนๆ จะช่วยให้หลับสบายคืนนี้",
        "อย่าลืมยืดกล้ามเนื้อ บรรเทาความตึงเครียดจากการนั่งนาน"
      ],
      "finance" => [
        "รายได้กำลังค่อยๆ ดีขึ้น จัดการการเงินอย่างมีวินัยจะมั่นคง",
        "วางแผนค่าใช้จ่ายวันนี้ จะช่วยลดความกังวลในอนาคต",
        "โอกาสเล็กๆ ทางการเงินกำลังจะมา คว้าไว้ให้ดี",
        "อย่ารีบร้อนลงทุน ศึกษาให้รอบด้านก่อนตัดสินใจ",
        "หมั่นออมเล็กๆ แต่สม่ำเสมอ จะกลายเป็นก้อนใหญ่",
        "มีเกณฑ์ได้ของที่อยากได้ในราคาคุ้มค่า",
        "ความพยายามในงานจะเปลี่ยนเป็นผลตอบแทนที่ดี",
        "ตัดค่าใช้จ่ายฟุ่มเฟือยหนึ่งอย่าง กระเป๋าจะเบาขึ้นทันที",
        "คนใกล้ตัวให้คำแนะนำการเงินที่มีประโยชน์ ลองฟังดู",
        "วันนี้เหมาะกับการทบทวนเป้าหมายทางการเงินอีกครั้ง"
      ]
    }

    fortunes_by_category_chinese = {
      "study" => [
        "学业顺遂，再接再厉",
        "良师益友，相伴前行",
        "温故知新，成绩可期",
        "开卷有益，进步飞快",
        "勤能补拙，必有佳讯",
        "循序渐进，心明眼亮",
        "不必多忧，基础扎实",
        "触类旁通，记忆长久",
        "疑则问之，进益神速",
        "张弛有度，精力充沛"
      ],
      "love" => [
        "情意渐浓，以诚相待",
        "桃花临门，缘来有时",
        "沟通真挚，感情稳固",
        "多些包容，风波自平",
        "一句暖语，胜过千言",
        "不急不躁，顺其自然",
        "点滴关怀，温暖长存",
        "且行且看，勿急定论",
        "放宽心胸，自见美好",
        "爱人先爱己，福自来"
      ],
      "health" => [
        "早睡早起，气色更佳",
        "多饮清水，润泽身心",
        "舒展筋骨，轻松自在",
        "量力而行，切莫逞强",
        "细微改良，立见其效",
        "饮食均衡，精力充沛",
        "定期体检，防患未然",
        "深呼吸静心，忧虑自减",
        "沐浴晨光，夜眠香甜",
        "缓解紧绷，身心轻盈"
      ],
      "finance" => [
        "财源渐进，守正以稳",
        "精打细算，未雨绸缪",
        "小有机遇，握之不失",
        "投资需谨慎，多方求证",
        "积少成多，日久见功",
        "物有所值，买得其所",
        "勤勉有成，酬劳自至",
        "节流一项，轻松不少",
        "善纳良言，收益颇多",
        "回顾目标，步步为营"
      ]
    }

    thai_fortunes = fortunes_by_category_thai[category] || fortunes_by_category_thai["study"]
    chinese_fortunes = fortunes_by_category_chinese[category] || fortunes_by_category_chinese["study"]

    thai_fortune = thai_fortunes.sample
    chinese_fortune = chinese_fortunes.sample
    
    # สุ่มสีโชคดี
    lucky_colors = ["แดง", "ทอง", "เหลือง", "ม่วง", "ชมพู"]
    lucky_color = lucky_colors.sample
    
    # สุ่มตัวเลขโชคดี
    lucky_numbers = Array.new(6) { rand(1..49) }.uniq.sort
    
    # สุ่มหมายเลขของรางวัลจากฐานข้อมูลและลบทันที
    prize_number = FortuneNumber.draw_and_remove!
    remaining_count = FortuneNumber.remaining_count
    
    if prize_number
      render json: {
        thai_fortune: thai_fortune,
        chinese_fortune: chinese_fortune,
        lucky_color: lucky_color,
        lucky_numbers: lucky_numbers,
        prize_number: prize_number,
        remaining_prizes: remaining_count,
        success: true
      }
    else
      render json: {
        success: false,
        message: "ของรางวัลหมดแล้ว! กรุณารีเซ็ตระบบ",
        remaining_prizes: 0
      }
    end
  end

  # ฟังก์ชันรีเซ็ตหมายเลขทั้งหมด (สำหรับ admin)
  def reset_numbers
    FortuneNumber.reset_all!
    render json: {
      success: true,
      message: "รีเซ็ตหมายเลขเสร็จแล้ว! มีหมายเลข 100 ตัวให้สุ่มใหม่",
      remaining_prizes: FortuneNumber.remaining_count
    }
  end

  # ฟังก์ชันลบตัวเลขเฉพาะ
  def delete_number
    number = params[:number].to_i
    
    if number < 1 || number > 100
      render json: {
        success: false,
        message: "กรุณาใส่หมายเลขระหว่าง 1-100"
      }
      return
    end
    
    fortune_number = FortuneNumber.find_by(number: number)
    
    if fortune_number
      fortune_number.destroy!
      render json: {
        success: true,
        message: "ลบหมายเลข #{number} เรียบร้อยแล้ว",
        remaining_prizes: FortuneNumber.remaining_count
      }
    else
      render json: {
        success: false,
        message: "ไม่พบหมายเลข #{number} ในระบบ (อาจถูกลบไปแล้ว)"
      }
    end
  end

  # ฟังก์ชันเช็คสถานะหมายเลขที่เหลือ
  def status
    render json: {
      remaining_prizes: FortuneNumber.remaining_count,
      has_prizes: FortuneNumber.any_remaining?
    }
  end
end
